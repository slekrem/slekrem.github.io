<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWC Demo - Nostr Wallet Connect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }
        .wallet-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .wallet-card .card-header {
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        .result-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status-badge {
            font-size: 0.875rem;
        }
        .btn-group-vertical .btn {
            margin-bottom: 5px;
        }
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-5 fw-bold text-primary">üîó Nostr Wallet Connect Demo</h1>
                <p class="lead">Experimentiere mit zwei NWC (Nostr Wallet Connect) Wallets gleichzeitig</p>
            </div>
        </div>

        <!-- Two Wallet Columns -->
        <div class="row">
            <!-- Wallet 1 -->
            <div class="col-lg-6 mb-4">
                <div class="wallet-card card h-100">
                    <div class="card-header text-center">
                        <h3 class="card-title mb-0">üí∞ Wallet 1</h3>
                    </div>
                    <div class="card-body">
                        <!-- Connection Section -->
                        <div class="mb-4">
                            <h5 class="card-subtitle mb-3">Verbindung</h5>
                            <div class="mb-3">
                                <label for="nwc-url-1" class="form-label">NWC Connection String:</label>
                                <textarea id="nwc-url-1" class="form-control" placeholder="nostr+walletconnect://pubkey?relay=wss://relay.example.com&secret=secret..." rows="3"></textarea>
                            </div>
                            <div class="d-grid gap-2 d-md-flex">
                                <button id="connect-btn-1" class="btn btn-primary flex-fill" onclick="connectWallet(1)">Verbinden</button>
                                <button id="disconnect-btn-1" class="btn btn-outline-secondary flex-fill" onclick="disconnectWallet(1)" disabled>Trennen</button>
                            </div>
                            <div class="mt-2">
                                <span id="connection-status-1" class="badge bg-secondary status-badge">Nicht verbunden</span>
                            </div>
                        </div>

                        <!-- Wallet Info -->
                        <div class="mb-4">
                            <h5 class="card-subtitle mb-3">Wallet Information</h5>
                            <div class="d-grid gap-2 d-md-flex mb-2">
                                <button class="btn btn-outline-info btn-sm flex-fill" onclick="getWalletInfo(1)">get_info</button>
                                <button class="btn btn-outline-info btn-sm flex-fill" onclick="getBalance(1)">get_balance</button>
                            </div>
                            <div id="wallet-info-1" class="result-display"></div>
                        </div>

                        <!-- Payment Actions -->
                        <div class="mb-3">
                            <h5 class="card-subtitle mb-3">Payment Aktionen</h5>
                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn btn-success btn-sm w-100" onclick="createInvoice(1)">Invoice Erstellen</button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-warning btn-sm w-100" onclick="payInvoice(1)">Invoice Bezahlen</button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-info btn-sm w-100" onclick="listTransactions(1)">Transaktionen</button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-secondary btn-sm w-100" onclick="payKeysend(1)">Keysend</button>
                                </div>
                            </div>
                            <div id="payment-result-1" class="result-display"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wallet 2 -->
            <div class="col-lg-6 mb-4">
                <div class="wallet-card card h-100">
                    <div class="card-header text-center">
                        <h3 class="card-title mb-0">üí≥ Wallet 2</h3>
                    </div>
                    <div class="card-body">
                        <!-- Connection Section -->
                        <div class="mb-4">
                            <h5 class="card-subtitle mb-3">Verbindung</h5>
                            <div class="mb-3">
                                <label for="nwc-url-2" class="form-label">NWC Connection String:</label>
                                <textarea id="nwc-url-2" class="form-control" placeholder="nostr+walletconnect://pubkey?relay=wss://relay.example.com&secret=secret..." rows="3"></textarea>
                            </div>
                            <div class="d-grid gap-2 d-md-flex">
                                <button id="connect-btn-2" class="btn btn-primary flex-fill" onclick="connectWallet(2)">Verbinden</button>
                                <button id="disconnect-btn-2" class="btn btn-outline-secondary flex-fill" onclick="disconnectWallet(2)" disabled>Trennen</button>
                            </div>
                            <div class="mt-2">
                                <span id="connection-status-2" class="badge bg-secondary status-badge">Nicht verbunden</span>
                            </div>
                        </div>

                        <!-- Wallet Info -->
                        <div class="mb-4">
                            <h5 class="card-subtitle mb-3">Wallet Information</h5>
                            <div class="d-grid gap-2 d-md-flex mb-2">
                                <button class="btn btn-outline-info btn-sm flex-fill" onclick="getWalletInfo(2)">get_info</button>
                                <button class="btn btn-outline-info btn-sm flex-fill" onclick="getBalance(2)">get_balance</button>
                            </div>
                            <div id="wallet-info-2" class="result-display"></div>
                        </div>

                        <!-- Payment Actions -->
                        <div class="mb-3">
                            <h5 class="card-subtitle mb-3">Payment Aktionen</h5>
                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn btn-success btn-sm w-100" onclick="createInvoice(2)">Invoice Erstellen</button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-warning btn-sm w-100" onclick="payInvoice(2)">Invoice Bezahlen</button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-info btn-sm w-100" onclick="listTransactions(2)">Transaktionen</button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-secondary btn-sm w-100" onclick="payKeysend(2)">Keysend</button>
                                </div>
                            </div>
                            <div id="payment-result-2" class="result-display"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug / Log Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="debug-section card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">üîç Debug Log</h5>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearLog()">Log L√∂schen</button>
                    </div>
                    <div class="card-body">
                        <div id="debug-log" class="result-display">Debug-Nachrichten werden hier angezeigt...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Import Alby NWC SDK locally -->
    <script type="module">
        import { LN, nwc } from '@getalby/sdk';

        // Real NWC functionality using @getalby/sdk - Dual Wallet Support
        const wallets = {
            1: { isConnected: false, nwcClient: null, connectionData: null },
            2: { isConnected: false, nwcClient: null, connectionData: null }
        };

        function log(message) {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateConnectionStatus(walletId, status, message) {
            const statusElement = document.getElementById(`connection-status-${walletId}`);
            const badgeClass = status === 'connected' ? 'bg-success' :
                              status === 'connecting' ? 'bg-warning' : 'bg-secondary';
            statusElement.className = `badge ${badgeClass} status-badge`;
            statusElement.textContent = message;
        }

        async function connectWallet(walletId) {
            const nwcUrl = document.getElementById(`nwc-url-${walletId}`).value;

            if (!nwcUrl) {
                alert('Bitte geben Sie eine g√ºltige NWC Connection String ein');
                return;
            }

            if (!nwcUrl.startsWith('nostr+walletconnect://')) {
                alert('Ung√ºltiger NWC Connection String. Muss mit "nostr+walletconnect://" beginnen');
                return;
            }

            log(`Wallet ${walletId}: Versuche echte Wallet zu verbinden...`);
            updateConnectionStatus(walletId, 'connecting', 'Verbindung wird hergestellt...');

            try {
                // Create new NWC client with credentials
                wallets[walletId].nwcClient = new nwc.NWCClient({ nostrWalletConnectUrl: nwcUrl });

                // Test connection by getting wallet info
                const info = await wallets[walletId].nwcClient.getInfo();

                wallets[walletId].isConnected = true;
                wallets[walletId].connectionData = { url: nwcUrl };
                updateConnectionStatus(walletId, 'connected', 'Verbunden');
                document.getElementById(`connect-btn-${walletId}`).disabled = true;
                document.getElementById(`disconnect-btn-${walletId}`).disabled = false;

                log(`Wallet ${walletId}: Erfolgreich verbunden!`);
                log(`Wallet ${walletId}: Alias: ${info.alias || 'N/A'}`);
                log(`Wallet ${walletId}: Pubkey: ${info.pubkey ? info.pubkey.substring(0, 20) + '...' : 'N/A'}`);
                log(`Wallet ${walletId}: Methods: ${info.methods ? info.methods.join(', ') : 'N/A'}`);

                // Display initial wallet info
                document.getElementById(`wallet-info-${walletId}`).textContent = JSON.stringify(info, null, 2);

            } catch (error) {
                updateConnectionStatus(walletId, 'disconnected', 'Verbindung fehlgeschlagen');
                log(`Wallet ${walletId}: Fehler beim Verbinden: ${error.message}`);
                console.error(`Wallet ${walletId} NWC Connection Error:`, error);
            }
        }

        function disconnectWallet(walletId) {
            log(`Wallet ${walletId}: Verbindung wird getrennt...`);
            wallets[walletId].isConnected = false;
            wallets[walletId].nwcClient = null;
            wallets[walletId].connectionData = null;
            updateConnectionStatus(walletId, 'disconnected', 'Nicht verbunden');
            document.getElementById(`connect-btn-${walletId}`).disabled = false;
            document.getElementById(`disconnect-btn-${walletId}`).disabled = true;
            document.getElementById(`wallet-info-${walletId}`).textContent = '';
            document.getElementById(`payment-result-${walletId}`).textContent = '';
            log(`Wallet ${walletId}: Erfolgreich getrennt`);
        }


        async function getWalletInfo(walletId) {
            if (!wallets[walletId].isConnected || !wallets[walletId].nwcClient) {
                alert(`Bitte verbinden Sie zuerst Wallet ${walletId}`);
                return;
            }

            try {
                log(`Wallet ${walletId}: get_info Request gesendet...`);
                const info = await wallets[walletId].nwcClient.getInfo();
                document.getElementById(`wallet-info-${walletId}`).textContent = JSON.stringify(info, null, 2);
                log(`Wallet ${walletId}: get_info Response erhalten`);
            } catch (error) {
                log(`Wallet ${walletId}: Fehler bei get_info: ${error.message}`);
                document.getElementById(`wallet-info-${walletId}`).textContent = `Error: ${error.message}`;
            }
        }

        async function getBalance(walletId) {
            if (!wallets[walletId].isConnected || !wallets[walletId].nwcClient) {
                alert(`Bitte verbinden Sie zuerst Wallet ${walletId}`);
                return;
            }

            try {
                log(`Wallet ${walletId}: get_balance Request gesendet...`);
                const balance = await wallets[walletId].nwcClient.getBalance();
                document.getElementById(`wallet-info-${walletId}`).textContent = JSON.stringify(balance, null, 2);
                log(`Wallet ${walletId}: Balance: ${balance.balance} sats`);
            } catch (error) {
                log(`Wallet ${walletId}: Fehler bei get_balance: ${error.message}`);
                document.getElementById(`wallet-info-${walletId}`).textContent = `Error: ${error.message}`;
            }
        }

        async function createInvoice(walletId) {
            if (!wallets[walletId].isConnected || !wallets[walletId].nwcClient) {
                alert(`Bitte verbinden Sie zuerst Wallet ${walletId}`);
                return;
            }

            const amount = prompt('Betrag in Satoshis eingeben:', '1000');
            if (!amount) return;

            const description = prompt('Beschreibung (optional):', `NWC Demo Invoice - Wallet ${walletId}`);

            try {
                log(`Wallet ${walletId}: make_invoice Request f√ºr ${amount} sats...`);
                const invoice = await wallets[walletId].nwcClient.makeInvoice({
                    amount: parseInt(amount) * 1000, // Convert to millisats
                    description: description || `NWC Demo Invoice - Wallet ${walletId}`
                });

                document.getElementById(`payment-result-${walletId}`).textContent = JSON.stringify(invoice, null, 2);
                log(`Wallet ${walletId}: Invoice erfolgreich erstellt`);
            } catch (error) {
                log(`Wallet ${walletId}: Fehler beim Erstellen der Invoice: ${error.message}`);
                document.getElementById(`payment-result-${walletId}`).textContent = `Error: ${error.message}`;
            }
        }

        async function payInvoice(walletId) {
            if (!wallets[walletId].isConnected || !wallets[walletId].nwcClient) {
                alert(`Bitte verbinden Sie zuerst Wallet ${walletId}`);
                return;
            }

            const invoice = prompt('Lightning Invoice eingeben:', 'lnbc...');
            if (!invoice) return;

            try {
                log(`Wallet ${walletId}: pay_invoice Request gesendet...`);
                const result = await wallets[walletId].nwcClient.payInvoice({ invoice: invoice });

                document.getElementById(`payment-result-${walletId}`).textContent = JSON.stringify(result, null, 2);
                log(`Wallet ${walletId}: Payment erfolgreich gesendet`);
            } catch (error) {
                log(`Wallet ${walletId}: Fehler beim Bezahlen: ${error.message}`);
                document.getElementById(`payment-result-${walletId}`).textContent = `Error: ${error.message}`;
            }
        }

        async function listTransactions(walletId) {
            if (!wallets[walletId].isConnected || !wallets[walletId].nwcClient) {
                alert(`Bitte verbinden Sie zuerst Wallet ${walletId}`);
                return;
            }

            try {
                log(`Wallet ${walletId}: list_transactions Request gesendet...`);

                // listTransactions mit optionalen Parametern
                const transactions = await wallets[walletId].nwcClient.listTransactions({
                    from: 0,
                    until: Math.floor(Date.now() / 1000),
                    limit: 50,
                    offset: 0,
                    unpaid: false,
                    type: undefined // alle Typen
                });

                document.getElementById(`payment-result-${walletId}`).textContent = JSON.stringify(transactions, null, 2);
                log(`Wallet ${walletId}: ${transactions.transactions ? transactions.transactions.length : 0} Transaktionen abgerufen`);
            } catch (error) {
                log(`Wallet ${walletId}: Fehler beim Abrufen der Transaktionen: ${error.message}`);
                console.error(`Wallet ${walletId} listTransactions error:`, error);

                // Fallback: Versuche ohne Parameter
                try {
                    log(`Wallet ${walletId}: Versuche listTransactions ohne Parameter...`);
                    const transactions = await wallets[walletId].nwcClient.listTransactions({});
                    document.getElementById(`payment-result-${walletId}`).textContent = JSON.stringify(transactions, null, 2);
                    log(`Wallet ${walletId}: Transaktionen mit Fallback-Methode abgerufen`);
                } catch (fallbackError) {
                    log(`Wallet ${walletId}: Auch Fallback fehlgeschlagen: ${fallbackError.message}`);
                    document.getElementById(`payment-result-${walletId}`).textContent = `Error: ${error.message}\nFallback Error: ${fallbackError.message}`;
                }
            }
        }

        async function payKeysend(walletId) {
            if (!wallets[walletId].isConnected || !wallets[walletId].nwcClient) {
                alert(`Bitte verbinden Sie zuerst Wallet ${walletId}`);
                return;
            }

            const pubkey = prompt('Empf√§nger Pubkey:', '02...');
            const amount = prompt('Betrag in Satoshis:', '1000');

            if (!pubkey || !amount) return;

            try {
                log(`Wallet ${walletId}: pay_keysend Request f√ºr ${amount} sats an ${pubkey.substring(0, 10)}...`);

                const result = await wallets[walletId].nwcClient.payKeysend({
                    pubkey: pubkey,
                    amount: parseInt(amount) * 1000 // Convert to millisats
                });

                document.getElementById(`payment-result-${walletId}`).textContent = JSON.stringify(result, null, 2);
                log(`Wallet ${walletId}: Keysend Payment erfolgreich gesendet`);
            } catch (error) {
                log(`Wallet ${walletId}: Fehler beim Keysend: ${error.message}`);
                document.getElementById(`payment-result-${walletId}`).textContent = `Error: ${error.message}`;
            }
        }


        function clearLog() {
            document.getElementById('debug-log').textContent = 'Debug-Nachrichten werden hier angezeigt...\n';
        }

        // Make functions globally available
        window.connectWallet = connectWallet;
        window.disconnectWallet = disconnectWallet;
        window.getWalletInfo = getWalletInfo;
        window.getBalance = getBalance;
        window.createInvoice = createInvoice;
        window.payInvoice = payInvoice;
        window.listTransactions = listTransactions;
        window.payKeysend = payKeysend;
        window.clearLog = clearLog;

        // Initialize
        window.addEventListener('load', () => {
            log('NWC Demo Seite geladen');
            log('ECHTE NWC INTEGRATION mit lokalen Dependencies - Verwenden Sie echte Wallet Connection Strings!');
            log('Unterst√ºtzte Wallets: Alby Hub, Coinos, Primal, lnwallet.app, Yakihonne...');
        });
    </script>
</body>
</html>
